# This is a bit complex with multiple jobs.
# https://circleci.com/docs/2.0/local-cli/ will let you test this locally
version: 2
workflows:
  version: 2
  test:
    jobs:
      - typescript
      - golang
      - rust
      - lint-rust

jobs:

  lint-rust:
    docker:
      - image: rust:1.56.1
    working_directory: ~/proofs/rust
    steps:
      - checkout:
          path: ~/proofs
      - run:
          name: Version information
          command: rustc --version; cargo --version; rustup --version; rustup target list --installed
      - restore_cache:
          keys:
            - cargocache-v2-lint-rust:1.56.1-{{ checksum "Cargo.toml" }}
      - run:
          name: Add rustfmt component
          command: rustup component add rustfmt
      - run:
          name: Add clippy component
          command: rustup component add clippy
      - run:
          name: Check formatting of workspace
          command: cargo fmt -- --check
      - run:
          name: Clippy linting on workspace (host-functions + std)
          command: cargo clippy --tests -- -D warnings
      - run:
          name: Clippy linting on workspace (no-std)
          command: cargo clippy --tests --no-default-features -- -D warnings
      - run:
          name: Clippy linting on workspace (host functions only)
          command: cargo clippy --tests --no-default-features --features host-functions -- -D warnings
      - save_cache:
          paths:
            - /usr/local/cargo/registry
            - target/debug/.fingerprint
            - target/debug/build
            - target/debug/deps
          key: cargocache-v2-lint-rust:1.56.1-{{ checksum "Cargo.toml" }}
